<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>活動詳情</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.2/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">

    <style>
        main {
            min-height: calc(100vh - 70px);
        }

        /* Set the size of the div element that contains the map */
        #map {
            height: 300px;
            /* The height is 400 pixels */
            width: 300px;
            /* The width is the width of the web page */
        }

        .join {
            position: sticky;
            bottom: 0;
        }

        /* 留言捲軸 */
        #scroll {
            overflow-y: scroll;
            max-height: 400px;
        }

        /* 留言頭像跟人名inline */
        .list-group {
            display: inline;
        }


        .category-icon {
            font-size: 2rem;
            /* Example size */
        }

        .category-card {
            border: none;
            transition: transform 0.3s;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

<div class="container">
    <header
            class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
        <div class="col-md-3 mb-2 mb-md-0">
            <a href="activity.html" class="d-inline-flex link-body-emphasis text-decoration-none">
                <span class="fs-4">做伙</span>
            </a>
        </div>

        <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0">
            <li><a href="activity.html" class="nav-link px-2 link-secondary">首頁</a></li>
            <li><a href="join.html" class="nav-link px-2 link-secondary">瀏覽活動</a></li>
            <li><a href="create.html" class="nav-link px-2 link-secondary">舉辦活動</a></li>
            <li><a href="rent.html" class="nav-link px-2 link-secondary">場地租借</a></li>
            <li><a href="customer.html" class="nav-link px-2 link-secondary">FAQs</a></li>
            <li><a href="about.html" class="nav-link px-2 link-secondary">關於我們</a></li>
        </ul>

        <div class="col-md-3 text-end">
            <button type="button" class="btn btn-outline-primary me-2"><a class="nav-link" href="#"
                                                                          data-bs-toggle="modal"
                                                                          data-bs-target="#loginModal">登入</a></button>
            <button type="button" class="btn btn-primary"><a class="nav-link" href="register.html">註冊</a></button>
        </div>
    </header>
</div>

<div class="container">
    <div class="text-bark text-center py-4">
        <div class="shadow p-3 mb-5 bg-body rounded">
            <h1>活動名稱</h1>
        </div>
    </div>

    <main class="my-4">
        <div class="row">
            <div class="col-md-8">
                <img src="" class="img-thumbnail" alt="...">
                <section>
                    <h2>活動詳情</h2>
                    <p>活動描述和詳細資訊</p>
                    <p>開始时间：2023-12-01 10:00 AM</p>
                    <p>结束时间：2023-12-01 4:00 PM</p>
                    <h3>活動訊息</h3>
                    <span>活動內容</span>
                </section>
            </div>
            <div class="col-md-4 border" id="right-div">
                <aside>
                    <h2>活動訊息</h2>
                    <p>地點：活動場地</p>
                    <p>主辦方：活動主辦方</p>
                    <p>聯繫信箱：contact@example.com</p>
                </aside>
                <div id="map"></div>
            </div>
        </div>

        <div class="mt-5 w-50">
            <div class="mt-3">
                <span class="fs-3 fw-bolder">留言區<span id="commentcount">X</span></span>
                <div class="card w-100 shadow-none p-3 mb-5 bg-light rounded" style="border: none;" id="scroll">
                    <div id="comments" class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group"><img src="." style="width: 35px; height: auto;" alt="小白"></li>
                            <li class="list-group-item">留言一</li>
                            <div class="d-flex">
                                <li class="list-group">4天前</li>
                                <li class="list-group ms-auto"><img src="">
                                    <a href="" class="report" style="text-decoration:none;" data-bs-toggle="modal"
                                       data-bs-target="#exampleModal" data-bs-whatever="@getbootstrap">檢舉</a>
                                </li>
                            </div>
                        </ul>
                    </div>
                    <button id="morecomments" type="button" class="btn btn-light" onclick="more()">查看更多</button>
                </div>
            </div>
            <div>

            </div>
            <form id="commentsform" class="row g-3">
                <label for="comment" class="visually-hidden">留言</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="comment" placeholder="輸入您的留言">
                    <button type="submit" class="btn btn-outline-primary">留言</button>
                </div>
            </form>
        </div>

        <div class="container mt-4 border" id="people">
            <div class="row">
                <div>
                    <h5>參與者(99)</h5>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="shadow p-3">
                        <img src="" class="img-fluid d-block mx-auto" style="width: 60px; height: auto">
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="shadow p-3">
                        <img src="" class="img-fluid d-block mx-auto" style="width: 60px; height: auto">
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="shadow p-3">
                        <img src="" class="img-fluid d-block mx-auto" style="width: 60px; height: auto">
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="shadow p-3">
                        <img src="" class="img-fluid d-block mx-auto" style="width: 60px; height: auto">
                    </div>
                </div>
            </div>
        </div>

        <div class="p-3 join">
            <div class="text-bark">
                <div class="shadow p-4 bg-body rounded">
                    <button type="button" class="btn btn-danger btn-lg mx-3" onclick="signup()">報名活動</button>
                    <button class="btn btn-outline-warning btn-lg" data-bs-toggle="modal"
                            data-bs-target="#actReportModal" data-bs-whatever="@getbootstrap" onclick="actReport()">檢舉活動</button>
                </div>
            </div>
        </div>
</div>
</main>
</div>

<div class="container">
    <footer class="py-3 my-4">
        <ul class="nav justify-content-center border-bottom pb-3 mb-3">
            <li class="nav-item"><a href="activity.html" class="nav-link px-2 text-muted">首頁</a></li>
            <li class="nav-item"><a href="customer.html" class="nav-link px-2 text-muted">客服中心</a></li>
            <li class="nav-item"><a href="about.html" class="nav-link px-2 text-muted">關於我們</a></li>
        </ul>
        <p class="text-center text-muted">© 2023 Company, Inc</p>
    </footer>
</div>

<!--檢舉留言框-->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">檢舉</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportfrom">
                    <div class="mb-3">
                        <label for="report-title" class="col-form-label">請選擇檢舉原因:</label>
                        <select class="form-control" id="report-title">
                            <option value="SPAM">垃圾訊息</option>
                            <option value="OFFENSIVE">不適當的內容</option>
                            <option value="HARASSMENT">人身攻擊或霸凌行為</option>
                            <option value="PRIVACY">侵犯隱私</option>
                            <option value="SENSITIVE">敏感或爭議性內容</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="message-text" class="col-form-label">請說出您的檢舉原因:</label>
                        <textarea class="form-control" id="message-text" style="width: 100%; height: 150px; resize:none;"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                        <button type="submit" class="btn btn-primary">送出</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!--檢舉活動框-->
<div class="modal fade" id="actReportModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actReportModalLabel">檢舉</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="actReportfrom">
                    <div class="mb-3">
                        <label for="report-title" class="col-form-label">請選擇檢舉原因:</label>
                        <select class="form-control" id="act-report-title">
                            <option value="SPAM">垃圾訊息</option>
                            <option value="OFFENSIVE">不適當的內容</option>
                            <option value="HARASSMENT">人身攻擊或霸凌行為</option>
                            <option value="PRIVACY">侵犯隱私</option>
                            <option value="SENSITIVE">敏感或爭議性內容</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="message-text" class="col-form-label">請說出您的檢舉原因:</label>
                        <textarea class="form-control" id="text" style="width: 100%; height: 150px; resize:none;"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                        <button type="submit" class="btn btn-primary">送出</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
</script>
<script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.2/dist/sweetalert2.all.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

<script src="googlemap.js"></script>

<script>

    //檢舉框的Modal
    var exampleModal;

    //new出檢舉框並存入,為了讓檢舉框按下送出後可以用exampleModal.hide()隱藏檢舉框
    exampleModal = new bootstrap.Modal(document.getElementById("exampleModal"), {
        keyboard: false
    });

    //初始留言數量
    var countLimit = 5;

    //當前顯示的留言數量
    var currentDisplayed = 0;

    //進入活動詳情頁面後要先跑一遍顯示所有留言
    $(function () {
        allComments(countLimit);
    });

    //按下查看更多按鈕將limit加5並且再跑一遍顯示所有留言
    function more() {
        countLimit += 5;
        allComments(countLimit);
    }

    //進畫面後顯示所有留言
    function allComments(countLimit) {
        $.ajax({
            url: '/comments',
            type: 'GET',
            data: {
                limit: countLimit
                // sort: userSort 讓用戶可以從新到舊 或舊到新
            },
            dataType: 'json',
            success: function (page) {

                var commentsHTML = "";
                var comments = page.comments;
                var total = page.total;
                var limit = page.limit;

                comments.forEach(function (comment) {
                    commentsHTML +=
                        '<ul class="list-group list-group-flush">' +
                        '<li class="list-group"><img src="" style="width: 35px; height: auto;" alt="">' + comment.memId + '</li>' +
                        '<li class="list-group-item">' + comment.comContent + '</li>' +
                        '<div class="d-flex">' +
                        '<li class="list-group">' + comment.comTime + '</li>' +
                        '<li class="list-group ms-auto">' +
                        '<img src=""><a href="#" class="report" style="text-decoration:none;" data-com-id="' + comment.comId + '"' +
                        'data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@getbootstrap">檢舉</a></li>' +
                        '</div>' +
                        '</ul>';
                });
                //留言總數
                $("#commentcount").html("(" + total + ")");

                if (comments.length > currentDisplayed) {
                    $("#comments").html(commentsHTML);

                    currentDisplayed = comments.length;
                } else {
                    $("#morecomments").prop("disabled", true).text("沒有更多留言");
                }

                // memid 用來顯示會員的大頭照
                //改排序 最新的在上面 並且按查看更多是往下增加不是往上

            },
            error: function (xhr, status, error) {
                console.error("Error:" + status + " " + error);
            }
        });
    }

    //新增留言
    $("#commentsform").on("submit", function (e) {
        e.preventDefault();

        // actId = window.location.pathname.split('/')[2]; // 假設活動ID在URL的第三个段落中

        // 假設從伺服器獲取memId值並儲存到localStorage
        // localStorage.setItem('memId', '從伺服器獲取的值');

        // var userMemId = localStorage.getItem('memId');
        // if (!userMemId) {
        //     console.error("未登入");
        //     return;
        // }

        var commentData = {
            actId: 1, //改動態抓
            memId: 1, //改動態抓 userMemId
            // comReplyId:null,
            comContent: $("#comment").val()
        };

        $.ajax({
            url: '/comments',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(commentData),
            dataType: 'json',
            success: function (comments) {
                $("#comment").val("");

                var commentsHTML = "";
                commentsHTML +=
                    '<ul class="list-group list-group-flush">' +
                    '<li class="list-group"><img src="" style="width: 35px; height: auto;" alt="">' + comments.memId + '</li>' +
                    '<li class="list-group-item">' + comments.comContent + '</li>' +
                    '<div class="d-flex">' +
                    '<li class="list-group">' + comments.comTime + '</li>' +
                    '<li class="list-group ms-auto">' +
                    '<img src=""><a href="#" class="report" style="text-decoration:none;" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@getbootstrap">檢舉</a></li>' +
                    '</div>' +
                    '</ul>';
                $("#comments").prepend(commentsHTML);

                // memid 會員編號 用來顯示會員的大頭照
            },
            error: function (xhr, status, error) {
                console.error("Error:" + status + " " + error);
            }
        });
    });

    //案檢舉後取得comId,並將comid存在檢舉model的form表單的data屬性
    $(document).on("click", ".report", function () {
        var comId = $(this).data("comId");
        $("#reportfrom").data("comId", comId);
    });

    //檢舉  如果有新留言沒重新整理頁面不能檢舉 會失敗 不知道為什麼
    $("#reportfrom").submit(function (e) {
        e.preventDefault();
        //抓自定義的data屬性設的值,去查全部留言ajax那邊看
        var thiscomId = $(this).data("comId");

        var commentReportData = {
            comId: thiscomId, //留言編號
            memId: 1, //改動態抓 userMemId
            repTitle: $("#report-title").val(),
            repContent: $("#message-text").val()
        };

        $.ajax({
            url: "/commentreport",
            type: "POST",
            contentType: 'application/json',
            data: JSON.stringify(commentReportData),
            success: function (response) {
                $("#message-text").val("");

                $.alert({
                    title: '檢舉成功!!',
                    content: '您的檢舉已成功，已交由後台人員處理中',
                });
                exampleModal.hide();
            },
            error: function (xhr, status, error) {
                $.alert({
                    title: '檢舉失敗!!',
                    content: '您的檢舉有問題，請再做確認',
                });
            }
        });
    });

    //報名活動按鈕
    function signup() {
        Swal.fire({
            title: '人數',
            input: 'text',
            inputPlaceholder: '報名人數',
            inputValidator: (value) => {
                if (!value) {
                    return '請輸入人數'
                }
                if (isNaN(value)) {
                    return '請輸入數字';
                }
                // if (value > 10) { //從後端抓報名人數
                //     return '超過人數上限了';
                // }
            },
            showCancelButton: true,
            confirmButtonText: '送出',
            cancelButtonText: '取消',
        }).then((result) => {
            if (result.isConfirmed && result.value) {

                // 假設從伺服器獲取memId值並儲存到localStorage
                // localStorage.setItem('memId', '從伺服器獲取的值');

                // var userMemId = localStorage.getItem('memId');
                // if (!userMemId) {
                //     console.error("未登入");
                //     return;
                // }

                // actId = window.location.pathname.split('/')[2]; // 假設活動ID在URL的第三个段落中

                var numberOfPeople = {
                    memId: 1, //改動態抓
                    actId: 1, //改動態抓 userMemId
                    regTotal: result.value
                }
                $.ajax({
                    url: '/actreg',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(numberOfPeople),
                    success: function (actReg) {
                        Swal.fire('報名成功!，您報名的人數：' + actReg.regTotal);
                    },
                    error: function (xhr, status, error) {
                        Swal.fire("報名失敗，請再多試試");
                    }
                });
            }
        });
    }

</script>

</body>

</html>